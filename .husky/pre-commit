#!/bin/sh
. "$(dirname "$0")/_/husky.sh" 2>/dev/null || true

set +e

echo "üßπ [husky] Auto-fix ESLint + Prettier (commit non bloqu√©)..."

# R√©cup√®re les fichiers modifi√©s mis en staging
FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|json|md|css|scss)$')

if [ -n "$FILES" ]; then
  echo "üîß Fichiers d√©tect√©s :"
  echo "$FILES"

  if command -v yarn >/dev/null 2>&1; then
    echo "üëâ Fix avec yarn..."
    echo "$FILES" | xargs yarn eslint --fix
    echo "$FILES" | xargs yarn prettier --write
  elif command -v npx >/dev/null 2>&1; then
    echo "üëâ Fix avec npx..."
    echo "$FILES" | xargs npx eslint --fix
    echo "$FILES" | xargs npx prettier --write
  else
    echo "‚ö†Ô∏è Ni yarn ni npx trouv√©s ‚Äî skip auto-fix."
  fi

  # R√©-ajoute les fichiers corrig√©s au commit
  git add $FILES

  echo "‚úÖ Auto-fix termin√© (non bloquant)"
else
  echo "‚ÑπÔ∏è Aucun fichier modifi√© pertinent ‚Äî skip ESLint/Prettier."
fi
# .husky/pre-commit (bash)
if git diff --cached --name-only | grep -E '\.json$' | xargs -r grep -l $'\xEF\xBB\xBF'; then
  echo "‚ùå BOM d√©tect√© dans JSON"; exit 1; fi
if git diff --cached --name-only | xargs -r grep -P -n '[\x{FEFF}\x{200B}\x{200D}\x{200E}\x{200F}\x{202A}-\x{202E}]'; then
  echo "‚ùå Caract√®res invisibles d√©tect√©s"; exit 1; fi

exit 0
