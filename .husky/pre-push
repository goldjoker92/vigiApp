#!/usr/bin/env sh
# .husky/pre-push ‚Äî NON BLOQUANT / ZERO INTERACTION / POSIX sh
# - G√©n√®re un petit rapport HTML local
# - Essaie d‚Äôouvrir le rapport en arri√®re-plan (Chrome si possible)
# - NE BLOQUE JAMAIS le push (exit 0 quoi qu‚Äôil arrive)

# Ne jamais stopper sur erreur
set +e

REPORT_DIR=".husky/logs"
REPORT_FILE="$REPORT_DIR/last-prepush-report.html"
mkdir -p "$REPORT_DIR" 2>/dev/null || true

have() { command -v "$1" >/dev/null 2>&1; }

status_cell() {
  case "$1" in
    ok)   printf "<td class='ok'>‚úÖ OK</td>";;
    warn) printf "<td class='warn'>‚ö†Ô∏è Warning</td>";;
    err)  printf "<td class='err'>‚ùå Error</td>";;
    *)    printf "<td>%s</td>" "$1";;
  esac
}

row() {
  LABEL="$1"; STATUS="$2"; RECO="$3"; LINK="$4"
  printf "<tr><td>%s</td>%s<td>%s</td><td><a href='%s' target='_blank'>link</a></td></tr>\n" \
    "$LABEL" "$(status_cell "$STATUS")" "$RECO" "$LINK" >> "$REPORT_FILE"
}

# Chemin absolu POSIX-safe (compatible Git Bash)
abs_path() {
  # 1) si realpath existe, on l'utilise
  if have realpath; then
    realpath "$1"
    return
  fi
  # 2) fallback POSIX : cd dans le dossier puis concat basename
  d="$(dirname -- "$1" 2>/dev/null)"
  b="$(basename -- "$1" 2>/dev/null)"
  # shellcheck disable=SC2164
  (cd "$d" 2>/dev/null && pwd -P)/"$b"
}

open_report_bg() {
  ABS="$(abs_path "$REPORT_FILE")"

  # macOS
  if have open; then
    if [ -d "/Applications/Google Chrome.app" ]; then
      nohup open -a "Google Chrome" "$ABS" >/dev/null 2>&1 &
    else
      nohup open "$ABS" >/dev/null 2>&1 &
    fi
  # Linux
  elif have xdg-open; then
    if have google-chrome; then
      nohup google-chrome "$ABS" >/dev/null 2>&1 &
    elif have chromium; then
      nohup chromium "$ABS" >/devnull 2>&1 &
    else
      nohup xdg-open "$ABS" >/dev/null 2>&1 &
    fi
  # Git Bash / Windows
  elif have cmd.exe; then
    # Ouvre avec le navigateur par d√©faut
    cmd.exe /C start "" "$(echo "$ABS" | sed 's#/#\\#g')" >/dev/null 2>&1
  fi

  printf "üîó Rapport: %s\n" "file://$ABS"
}

# ---------- G√©n√©ration HTML ----------
cat > "$REPORT_FILE" <<'EOF'
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Husky Pre-push Report</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#181A20; color:#EEE; padding:20px; }
  h1 { color:#22C55E; margin:0 0 8px; }
  #subtitle { color:#9aa3b2; margin:0 0 16px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { padding:10px; border:1px solid #333; text-align:left; }
  th { background:#222; }
  .ok { color:#22C55E; font-weight:bold; }
  .warn { color:#FACC15; font-weight:bold; }
  .err { color:#EF4444; font-weight:bold; }
  a { color:#22C55E; font-weight:bold; text-decoration:none; }
  a:hover { text-decoration:underline; }
  .summary { margin-top:18px; padding:12px; background:#11151c; border:1px solid #2a2f3a; border-radius:8px; }
</style>
</head>
<body>
<h1>üö¶ Husky Pre-push Report</h1>
<p id="subtitle">R√©sum√© ultra-rapide (non bloquant).</p>
<table>
<tr><th>V√©rification</th><th>Statut</th><th>Recommandation</th><th>Docs</th></tr>
EOF

# D√©tections l√©g√®res (aucune commande lourde ex√©cut√©e)
NODE_V="$(node -v 2>/dev/null)"
if [ -n "$NODE_V" ]; then
  row "Node pr√©sent ($NODE_V)" ok "OK" "https://nodejs.org"
else
  row "Node non trouv√©" warn "Installe Node (>=18) quand tu peux" "https://nodejs.org/en/download"
fi

if have pnpm; then PM="pnpm"
elif have yarn; then PM="yarn"
elif have npm; then PM="npm"
else PM="-"; fi
if [ "$PM" = "-" ]; then
  row "Package manager" warn "Installe pnpm/yarn/npm" "https://pnpm.io / https://yarnpkg.com / https://docs.npmjs.com"
else
  row "Package manager d√©tect√©" ok "Utilisation de $PM" "#"
fi

if [ -f pnpm-lock.yaml ] || [ -f yarn.lock ] || [ -f package-lock.json ]; then
  row "Lockfile" ok "OK" "#"
else
  row "Lockfile" warn "Cr√©e un lockfile pour des builds reproductibles" "#"
fi

if [ -f package.json ]; then
  row "Lint" warn "Tu peux lancer '$PM run lint' plus tard si besoin" "cmd:$PM run lint"
else
  row "package.json" ok "Projet non JS/TS : rien √† faire" "#"
fi

cat >> "$REPORT_FILE" <<'EOF'
</table>
<div class="summary">
  <p>‚úÖ Conclusion : push autoris√©. Ce hook n'est jamais bloquant.</p>
</div>
</body></html>
EOF

# Ouvre le rapport en arri√®re-plan (sans bloquer le push)
open_report_bg || true

echo "‚úÖ [husky] Pre-push non-bloquant ex√©cut√©. Le push continue."
exit 0
