#!/bin/sh
set +e

REPORT_DIR=".husky/logs"
mkdir -p "$REPORT_DIR"
REPORT_FILE="$REPORT_DIR/last-prepush-report.html"

# ---------- Helpers ----------
have() { command -v "$1" >/dev/null 2>&1; }
status_ok()   { echo "<td class='ok'>‚úÖ OK</td>"; }
status_warn() { echo "<td class='warn'>‚ö†Ô∏è Warning</td>"; }
status_err()  { echo "<td class='err'>‚ùå Error</td>"; }
row() { echo "<tr><td>$1</td>$2<td>$3</td><td><a href='$4'>link</a></td></tr>" >> "$REPORT_FILE"; }

ask_and_run() {
  local msg="$1"
  local cmd="$2"
  echo ""
  echo "‚ùì $msg"
  echo "üëâ Run command? (y/n, auto-skip in 15s)"
  echo "   $cmd"

  local ans=""
  for i in $(seq 15 -1 1); do
    echo -ne "\r‚è≥ Waiting ($i s)... "
    read -t 1 ans
    if [ "$ans" = "y" ]; then
      echo ""
      echo "‚ñ∂Ô∏è Running: $cmd"
      eval "$cmd"
      return 0
    elif [ "$ans" = "n" ]; then
      echo ""
      echo "‚è© Skipped."
      return 0
    fi
  done
  echo ""
  echo "‚è© No response, skipped."
}

# ---------- Start HTML ----------
cat > "$REPORT_FILE" <<EOF
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Husky Pre-push Report</title>
<style>
  body { font-family:sans-serif; background:#181A20; color:#EEE; padding:20px; }
  h1 { color:#22C55E; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { padding:10px; border:1px solid #333; text-align:left; }
  th { background:#222; }
  .ok { color:#22C55E; font-weight:bold; }
  .warn { color:#FACC15; font-weight:bold; }
  .err { color:#EF4444; font-weight:bold; }
  a { color:#22C55E; font-weight:bold; text-decoration:none; }
  a:hover { text-decoration:underline; }
</style>
</head>
<body>
<h1>üö¶ Husky Pre-push Report</h1>
<p>You can click on the green link to see documentation or run recommended fixes.</p>
<table>
<tr><th>Check</th><th>Status</th><th>Recommendation</th><th>Docs</th></tr>
EOF

# (‚Ä¶ tes checks Node/Yarn/Expo/Lockfile/Doctor ici ‚Ä¶)

# ---------- Close HTML ----------
cat >> "$REPORT_FILE" <<EOF
</table>
<p style="margin-top:20px;font-weight:bold;">
‚úÖ Conclusion: Your push is allowed. Some checks may need attention (‚ö†Ô∏è),
but nothing blocks the push. Use the recommendations above to fix your environment.
</p>
</body></html>
EOF

echo ""
echo "‚úÖ [husky] Pre-push finished. Push allowed."
echo "üëâ You can click on this green link to see the detailed report:"
echo -e "\033[32mfile://$REPORT_FILE\033[0m"
echo ""

# ---------- Auto-open in browser (unless NO_AUTO_OPEN=1) ----------
if [ "$NO_AUTO_OPEN" != "1" ]; then
  case "$(uname)" in
    Darwin*) open "$REPORT_FILE" ;;                  # macOS
    Linux*) xdg-open "$REPORT_FILE" >/dev/null 2>&1 & ;;  # Linux
    MINGW*|MSYS*|CYGWIN*) start "" "$REPORT_FILE" ;;      # Windows
  esac
else
  echo "‚ÑπÔ∏è NO_AUTO_OPEN=1 detected ‚Üí not opening browser automatically."
fi

exit 0
