#!/bin/sh
. "$(dirname "$0")/_/husky.sh" 2>/dev/null || true
set +e

ask_and_run () {
  msg=$1
  cmd=$2

  echo "‚ùì $msg"
  printf "   üëâ Lancer la commande maintenant ? (y/n) "
  read ans
  case "$ans" in
    y|Y|yes)
      echo "‚ñ∂Ô∏è  Execution: $cmd"
      eval "$cmd"
      ;;
    *)
      echo "‚è≠Ô∏è  Skip (tu pourras lancer manuellement: $cmd)"
      ;;
  esac
}

echo "üö¶ [husky] Pr√©-push ‚Äî v√©rifications lecture seule (non bloquant)"

# --- Node version ---
if command -v node >/dev/null 2>&1; then
  NODE_MAJOR=$(node -p 'process.versions.node.split(".")[0]')
  if [ "$NODE_MAJOR" -lt 18 ]; then
    ask_and_run "Node <18 d√©tect√©. Installer Node 18 avec nvm ?" \
      "nvm install 18 && nvm use 18"
  fi
else
  ask_and_run "Node non install√©. Installer Node 18 ?" \
    "npm install -g node"
fi

# --- Expo deps check ---
if command -v npx >/dev/null 2>&1; then
  CI=1 npx expo install --check >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    if command -v yarn >/dev/null 2>&1; then
      ask_and_run "Incoh√©rences Expo d√©tect√©es. Corriger ?" "yarn install"
    else
      ask_and_run "Incoh√©rences Expo d√©tect√©es. Corriger avec npm ?" "npm install"
    fi
  fi
fi

# --- Yarn lockfile ---
if command -v yarn >/dev/null 2>&1; then
  YARN_MAJOR=$(yarn -v | cut -d. -f1)
  if [ "$YARN_MAJOR" -ge 2 ]; then
    yarn install --immutable --mode=skip-build >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      ask_and_run "Lockfile drift (Berry). Corriger ?" "yarn install && yarn dedupe"
    fi
  else
    yarn install --frozen-lockfile --ignore-scripts >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      ask_and_run "Lockfile drift (Yarn v1). Corriger ?" \
        "npm i -D yarn-deduplicate && npx yarn-deduplicate yarn.lock && yarn install"
    fi
  fi
fi

# --- Expo doctor ---
if command -v npx >/dev/null 2>&1; then
  npx expo doctor >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    ask_and_run "expo doctor signale des probl√®mes. Lancer maintenant ?" "npx expo doctor"
  fi
fi

echo "‚úÖ [husky] Pr√©-push termin√©. Push autoris√©."
exit 0
